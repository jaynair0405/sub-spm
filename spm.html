<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SPM Insights Console</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand: #0b3d91;
        --brand-soft: #eef3ff;
        --accent: #f0b429;
        --border: #d7ddec;
        --text: #1f2533;
        --muted: #5b6070;
        --card: #ffffff;
        --bg: #f5f7fb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, var(--bg), #edf1fc);
        color: var(--text);
        min-height: 100vh;
      }
      .page-shell {
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px 22px 40px;
      }
      header {
        background: var(--brand);
        color: #fff;
        padding: 20px 24px;
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        box-shadow: 0 20px 45px rgba(11, 61, 145, 0.25);
      }
      header h1 {
        margin: 0;
        font-size: 1.8rem;
        letter-spacing: 0.01em;
      }
      header span {
        font-size: 0.95rem;
        opacity: 0.95;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.1);
        font-size: 0.85rem;
      }
      .content {
        margin-top: -30px;
      }
      .card {
        background: var(--card);
        border-radius: 16px;
        padding: 18px 20px;
        margin-bottom: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 15px 60px rgba(15, 27, 65, 0.08);
      }
      .card h2 {
        margin: 0 0 18px;
        font-size: 1.2rem;
        color: var(--brand);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
        gap: 18px;
        margin-bottom: 10px;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.92rem;
        color: var(--muted);
      }
      input,
      select {
        font: inherit;
        padding: 11px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        transition: border 0.15s ease, box-shadow 0.15s ease;
      }
      input:focus,
      select:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.15);
        outline: none;
      }
      .upload-zone {
        position: relative;
        border: 2px dashed #b8c6e3;
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        background: var(--brand-soft);
        transition: border-color 0.2s ease, background 0.2s ease;
        cursor: pointer;
      }
      .upload-zone.dragover {
        border-color: var(--brand);
        background: #dfebff;
      }
      .upload-zone h3 {
        margin: 6px 0 8px;
        font-size: 1.2rem;
        color: var(--brand);
      }
      .upload-zone p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--muted);
      }
      .upload-zone button {
        margin-top: 16px;
      }
      .upload-zone input {
        position: absolute;
        inset: 0;
        opacity: 0;
        pointer-events: none;
      }
      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 16px;
      }
      button {
        font: inherit;
        border: none;
        border-radius: 14px;
        padding: 12px 20px;
        cursor: pointer;
        background: var(--brand);
        color: #fff;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
        box-shadow: 0 12px 24px rgba(11, 61, 145, 0.2);
      }
      button.secondary {
        background: var(--accent);
        color: #1d1400;
        box-shadow: 0 12px 24px rgba(240, 180, 41, 0.35);
      }
      button:hover {
        transform: translateY(-1px);
      }
      .panels {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 22px;
      }
      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        font-weight: 600;
        color: var(--brand);
      }
      .table-wrapper {
        overflow-x: auto;
        border: 1px solid var(--border);
        border-radius: 16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 420px;
      }
      th,
      td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
        text-align: left;
      }
      th {
        background: #f8faff;
        font-weight: 600;
        color: var(--muted);
      }
      tbody tr:last-child td {
        border-bottom: none;
      }
      #chart {
        width: 100%;
        height: 320px;
        cursor: crosshair;
      }
      .subtle {
        color: var(--muted);
        font-size: 0.85rem;
      }
      @media (max-width: 680px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }
        .upload-zone {
          padding: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page-shell">
      <header>
        <div>
          <div class="badge">Central Railway • SPM</div>
          <h1>Suburban Performance Monitor</h1>
          <span>Upload SPM runs, select staff, and review train performance visually.</span>
        </div>
        <div class="badge">Beta Workspace</div>
      </header>

      <main class="content">
        <section class="card">
          <h2>Upload Run & Assign Metadata</h2>
          <div
            class="upload-zone"
            id="uploadZone"
          >
            <input
              type="file"
              id="fileInput"
              accept=".csv,.xlsx,.xls"
            />
            <h3>Drop CSV/Excel file here</h3>
            <p>Supported formats: CSV, XLSX, XLS</p>
            <button type="button">Browse Files</button>
          </div>
          <p
            class="subtle"
            id="fileInfo"
          >
            No file selected yet.
          </p>

          <div class="grid">
            <label>
              Staff ID
              <select id="staffId">
                <option value="" selected>Select staff (from DB soon)</option>
                <option value="STF1234">STF1234 • Vinod Singh</option>
                <option value="STF1956">STF1956 • Ravi Sharma</option>
                <option value="STF2277">STF2277 • Anita Desai</option>
              </select>
            </label>
            <label>
              From Station
              <input
                type="text"
                id="fromStation"
                placeholder="e.g., CSMT, VDLR, TNA (optional)"
              />
            </label>
            <label>
              To Station
              <input
                type="text"
                id="toStation"
                placeholder="e.g., KYN, PNVL, TNA (optional)"
              />
            </label>
            <label>
              Train Number
              <input
                type="text"
                id="trainNumber"
                placeholder="e.g., K40, 96035"
              />
            </label>
            <label>
              Notes
              <input
                type="text"
                id="notes"
                placeholder="Optional remarks"
              />
            </label>
          </div>
          <div class="actions">
            <button type="button" id="processBtn">Process Run</button>
            <button
              type="button"
              class="secondary"
              id="clearBtn"
            >
              Reset Form
            </button>
          </div>
        </section>

        <section class="card">
          <div class="panel-header">
            <span>Summary Table</span>
            <span class="subtle">First 15 rows</span>
          </div>
          <div class="table-wrapper">
            <table id="dataTable">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Speed (km/h)</th>
                  <th>Distance (km)</th>
                  <th>Event</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <section class="card">
          <div class="panel-header">
            <span>Railway Line Diagram</span>
            <span class="subtle">Platform entry speeds • Green: ≤43 km/h • Red: >43 km/h</span>
          </div>
          <div style="width: 100%; height: 150px;">
            <svg id="railwayLine" style="width: 100%; height: 100%;"></svg>
          </div>
        </section>

        <section class="card">
          <div class="panel-header">
            <span>Speed Profile Chart</span>
            <span class="subtle">Distance vs Speed</span>
          </div>
          <div id="chart"></div>
        </section>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
    <script>
      const uploadZone = document.getElementById("uploadZone");
      const fileInput = document.getElementById("fileInput");
      const fileInfo = document.getElementById("fileInfo");
      const processBtn = document.getElementById("processBtn");
      const clearBtn = document.getElementById("clearBtn");

      const renderTable = (rows = []) => {
        const tbody = document.querySelector("#dataTable tbody");
        tbody.innerHTML = "";
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.time}</td>
            <td>${row.speed}</td>
            <td>${row.distance}</td>
            <td>${row.event}</td>
          `;
          tbody.appendChild(tr);
        });
      };

      let chart = null;

      function initChart() {
        const chartEl = document.getElementById("chart");
        if (chartEl && !chart) {
          chart = echarts.init(chartEl);
        }
        return chart;
      }

      const CHART_API_BASE = "http://127.0.0.1:8000";
      let currentRunId = null;

      async function uploadFile() {
        const file = fileInput.files[0];
        if (!file) {
          alert("Please select a file first");
          return null;
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("staff_id", document.getElementById("staffId").value);
        formData.append("from_station", document.getElementById("fromStation").value);
        formData.append("to_station", document.getElementById("toStation").value);
        formData.append("train_number", document.getElementById("trainNumber").value);
        formData.append("notes", document.getElementById("notes").value);

        try {
          const response = await fetch(`${CHART_API_BASE}/upload`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorText = await response.text();
            alert(`Upload error: ${errorText}`);
            return null;
          }

          const result = await response.json();
          return result;
        } catch (err) {
          console.error(err);
          alert("Upload failed: " + err.message);
          return null;
        }
      }

      function createRailwayLine(stationData) {
        if (!stationData || stationData.length === 0) {
          // Clear the SVG if no data
          const svg = document.getElementById('railwayLine');
          svg.innerHTML = '';
          return;
        }

        // Fixed width to fit in one view - no scrolling!
        const width = 1050;
        const height = 150;
        const padding = 30;
        const lineY = height / 2;
        const SPEED_THRESHOLD = 43; // Green ≤ 43, Red > 43

        // Get max distance for scaling
        const maxDistance = Math.max(...stationData.map(s => s.distance));

        // Set up SVG
        const svg = document.getElementById('railwayLine');
        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', '100%');
        svg.style.maxWidth = '100%';

        // Clear existing content
        while (svg.firstChild) {
          svg.removeChild(svg.firstChild);
        }

        // Create main railway line
        const mainLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        mainLine.setAttribute('x1', padding);
        mainLine.setAttribute('y1', lineY);
        mainLine.setAttribute('x2', width - padding);
        mainLine.setAttribute('y2', lineY);
        mainLine.setAttribute('stroke', '#333');
        mainLine.setAttribute('stroke-width', '2.5');
        svg.appendChild(mainLine);

        // Function to calculate x position based on distance
        function getXPosition(distance) {
          return (distance / maxDistance) * (width - 2 * padding) + padding;
        }

        // Add stations
        stationData.forEach((station, index) => {
          const xPos = getXPosition(station.distance);

          // Create station circle
          const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circle.setAttribute('cx', xPos);
          circle.setAttribute('cy', lineY);
          circle.setAttribute('r', 6);

          // Color based on speed
          if (station.speed <= SPEED_THRESHOLD) {
            circle.setAttribute('fill', '#00cc00'); // Green
            circle.setAttribute('stroke', '#009900');
          } else {
            circle.setAttribute('fill', '#ff0000'); // Red
            circle.setAttribute('stroke', '#cc0000');
          }
          circle.setAttribute('stroke-width', '1.5');
          svg.appendChild(circle);

          // Station name (alternating above/below)
          const stationText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          stationText.textContent = station.station.replace('Entry', '').trim();
          stationText.setAttribute('x', xPos);
          stationText.setAttribute('y', index % 2 === 0 ? lineY - 20 : lineY + 32);
          stationText.setAttribute('text-anchor', 'middle');
          stationText.setAttribute('font-size', '10px');
          stationText.setAttribute('font-family', 'Inter, Arial, sans-serif');
          stationText.setAttribute('font-weight', '600');
          stationText.setAttribute('fill', '#0b3d91');
          svg.appendChild(stationText);

          // Speed label (alternating above/below) - just the number
          const speedText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          speedText.textContent = station.speed.toFixed(0);
          speedText.setAttribute('x', xPos);
          speedText.setAttribute('y', index % 2 === 0 ? lineY - 8 : lineY + 44);
          speedText.setAttribute('text-anchor', 'middle');
          speedText.setAttribute('font-size', '10px');
          speedText.setAttribute('font-family', 'Inter, Arial, sans-serif');
          speedText.setAttribute('font-weight', 'bold');
          speedText.setAttribute('fill', station.speed <= SPEED_THRESHOLD ? '#00aa00' : '#cc0000');
          svg.appendChild(speedText);
        });
      }

      async function loadChartData(runId = null) {
        try {
          const body = runId ? { run_id: runId } : {};
          const response = await fetch(`${CHART_API_BASE}/chart_data`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          if (!response.ok) {
            const errorText = await response.text();
            alert(`Chart data error: ${errorText}`);
            return;
          }

          const payload = await response.json();

          const samples = payload.samples ?? [];

          // Create railway line diagram from station halt data
          if (payload.station_markers && payload.station_markers.length > 0) {
            // Extract platform entry speeds for railway line
            const stationHaltData = payload.station_markers.map(marker => {
              // Use platform entry speed if available, otherwise fallback to halt speed
              const sample = samples[marker.sample_index];
              const speed = marker.platform_entry_speed !== null && marker.platform_entry_speed !== undefined
                ? marker.platform_entry_speed
                : (sample ? sample.speed : 0);

              return {
                station: marker.station,
                distance: sample ? sample.cumulative_distance : 0,
                speed: speed
              };
            }).filter(s => s.distance >= 0); // Include start station at 0 distance

            createRailwayLine(stationHaltData);
          } else {
            // Clear railway line if no station data
            createRailwayLine([]);
          }

          // Update table with first 15 rows
          const tableRows = samples.slice(0, 15).map((sample) => ({
            time: sample.timestamp ?? "-",
            speed: sample.speed ?? "-",
            distance: sample.distance ?? "-",
            event: sample.station ?? "",
          }));
          renderTable(tableRows);

          // Update chart with all data
          const distances = samples.map((s) => s.cumulative_distance ? s.cumulative_distance.toFixed(1) : s.distance.toFixed(1));
          const speeds = samples.map((s) => s.speed);
          const psrValues = samples.map((s) => s.psr || null);

          // Check if PSR data is available
          const hasPSR = psrValues.some(v => v !== null);

          const chartInstance = initChart();
          if (!chartInstance) {
            console.error("Failed to initialize chart");
            return;
          }

          // Build series array
          const series = [];

          // Add PSR/MPS series first (so it appears behind the speed line)
          if (hasPSR) {
            series.push({
              name: 'MPS/PSR',
              type: 'line',
              data: psrValues,
              smooth: false,
              lineStyle: { color: '#00c800', width: 1 },
              areaStyle: { color: 'rgba(0, 200, 0, 0.25)' },
              showSymbol: false,
              z: 1,  // Draw behind speed line
            });
          }

          // Prepare station markers (vertical dashed lines with station names)
          const stationMarkLines = [];
          if (payload.station_markers && payload.station_markers.length > 0) {
            payload.station_markers.forEach(marker => {
              stationMarkLines.push({
                xAxis: marker.sample_index,
                label: {
                  formatter: marker.station,
                  position: 'insideEndTop',
                  fontSize: 10,
                  color: '#333',
                  backgroundColor: 'rgba(255, 255, 255, 0.9)',
                  padding: [2, 4],
                  borderRadius: 3
                },
                lineStyle: {
                  color: '#888',
                  type: 'dashed',
                  width: 1
                }
              });
            });
          }

          // Add actual speed series with station markers
          series.push({
            name: 'Actual Speed',
            type: 'line',
            data: speeds,
            smooth: true,
            lineStyle: { color: '#0b3d91', width: 2 },
            showSymbol: false,
            z: 2,  // Draw on top
            markLine: stationMarkLines.length ? {
              symbol: 'none',
              data: stationMarkLines
            } : undefined
          });

          // Add violation markers if available
          if (payload.violations && payload.violations.length > 0) {
            const violationData = samples.map((s, idx) => {
              const violation = payload.violations.find(v => v.index === idx);
              return violation ? s.speed : null;
            });

            series.push({
              name: 'Violations',
              type: 'scatter',
              data: violationData,
              symbolSize: 8,
              itemStyle: { color: '#ff0000' },
              z: 3,  // Draw on top of everything
            });
          }

          chartInstance.setOption({
            title: {
              text: hasPSR ? 'Speed Profile with PSR/MPS Overlay' : 'Speed Profile',
              left: 'center',
              top: 5,
              textStyle: { fontSize: 14, fontWeight: 600, color: '#0b3d91' }
            },
            tooltip: {
              trigger: 'axis',
              formatter: function(params) {
                let tip = `<b>Distance: ${params[0].axisValue} km</b><br/>`;
                params.forEach(param => {
                  if (param.value !== null) {
                    const color = param.color;
                    tip += `<span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;background-color:${color};"></span>`;
                    tip += `${param.seriesName}: ${param.value} km/h<br/>`;
                  }
                });
                return tip;
              }
            },
            legend: {
              data: hasPSR ? ['MPS/PSR', 'Actual Speed', 'Violations'] : ['Actual Speed'],
              top: 28,
              textStyle: { fontSize: 10 }
            },
            grid: { left: 50, right: 30, top: 65, bottom: 50 },
            xAxis: {
              type: 'category',
              data: distances,
              name: 'Cumulative Distance (km)',
              nameLocation: 'middle',
              nameGap: 30,
              axisLabel: { fontSize: 9, rotate: 45 }
            },
            yAxis: {
              type: 'value',
              name: 'Speed (km/h)',
              nameLocation: 'middle',
              nameGap: 35,
              axisLabel: { fontSize: 9 }
            },
            series: series
          });

        } catch (err) {
          console.error(err);
          alert("Unable to load chart data");
        }
      }

      const onFilesSelected = (files) => {
        if (!files || !files.length) {
          fileInfo.textContent = "No file selected yet.";
          return;
        }
        const file = files[0];
        fileInfo.textContent = `${file.name} • ${(file.size / 1024).toFixed(
          1
        )} KB`;
      };

      uploadZone.addEventListener("click", (e) => {
        // Only trigger if not clicking the input itself
        if (e.target !== fileInput) {
          fileInput.click();
        }
      });
      uploadZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadZone.classList.add("dragover");
      });
      uploadZone.addEventListener("dragleave", () =>
        uploadZone.classList.remove("dragover")
      );
      uploadZone.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadZone.classList.remove("dragover");
        onFilesSelected(e.dataTransfer.files);
      });
      fileInput.addEventListener("change", (e) =>
        onFilesSelected(e.target.files)
      );

      processBtn.addEventListener("click", async () => {
        processBtn.disabled = true;
        processBtn.textContent = "Processing...";

        try {
          // Upload file first
          const uploadResult = await uploadFile();

          if (uploadResult && uploadResult.success) {
            currentRunId = uploadResult.run_id;

            // Show success message
            const summary = uploadResult.summary;
            let message = `✓ Upload successful!\n\n` +
              `Rows: ${uploadResult.rows_processed}\n` +
              `Max Speed: ${summary.max_speed} km/h\n` +
              `Avg Speed: ${summary.avg_speed.toFixed(1)} km/h\n` +
              `Total Distance: ${summary.total_distance.toFixed(2)} km\n`;

            // Add PSR/MPS info if available
            if (summary.psr_calculated) {
              message += `\n✓ PSR/MPS: Calculated\n`;
              message += `Train Type: ${uploadResult.train_type || 'unknown'}\n`;
              message += `Halts Detected: ${uploadResult.halts_detected || 0}\n`;

              if (uploadResult.violation_count > 0) {
                message += `\n⚠️ Violations Found: ${uploadResult.violation_count}\n`;
                const vsum = uploadResult.violations_summary;
                if (vsum.critical > 0) message += `  • Critical: ${vsum.critical}\n`;
                if (vsum.severe > 0) message += `  • Severe: ${vsum.severe}\n`;
                if (vsum.moderate > 0) message += `  • Moderate: ${vsum.moderate}\n`;
                if (vsum.minor > 0) message += `  • Minor: ${vsum.minor}\n`;
              }
            }

            alert(message);

            // Load chart data for this run
            await loadChartData(currentRunId);
          }
        } catch (err) {
          console.error(err);
          alert("Processing failed: " + err.message);
        } finally {
          processBtn.disabled = false;
          processBtn.textContent = "Process Run";
        }
      });

      clearBtn.addEventListener("click", () => {
        fileInput.value = "";
        fileInfo.textContent = "No file selected yet.";
        document.getElementById("staffId").selectedIndex = 0;
        document.getElementById("fromStation").selectedIndex = 0;
        document.getElementById("toStation").selectedIndex = 0;
        document.getElementById("trainNumber").value = "";
        document.getElementById("notes").value = "";
      });

      // Make chart responsive
      window.addEventListener("resize", () => {
        if (chart) {
          chart.resize();
        }
      });
    </script>
  </body>
</html>
