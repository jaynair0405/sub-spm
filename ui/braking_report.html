<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Braking Pattern Analysis - Fortnightly Report</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      :root {
        --brand: #0b3d91;
        --brand-soft: #eef3ff;
        --accent: #f0b429;
        --border: #d7ddec;
        --text: #1f2533;
        --muted: #5b6070;
        --card: #ffffff;
        --bg: #f5f7fb;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, var(--bg), #edf1fc);
        color: var(--text);
        min-height: 100vh;
      }
      .page-shell {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px 22px 40px;
      }
      header {
        background: var(--brand);
        color: #fff;
        padding: 20px 24px;
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        box-shadow: 0 20px 45px rgba(11, 61, 145, 0.25);
        margin-bottom: 20px;
      }
      header h1 {
        margin: 0;
        font-size: 1.6rem;
        letter-spacing: 0.01em;
      }
      header span {
        font-size: 0.95rem;
        opacity: 0.95;
      }
      .back-link {
        color: #fff;
        text-decoration: none;
        font-size: 0.9rem;
        opacity: 0.9;
      }
      .back-link:hover { opacity: 1; text-decoration: underline; }

      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 20px 24px;
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.06);
        margin-bottom: 20px;
      }
      .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 16px;
        color: var(--brand);
      }

      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .form-group label {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--muted);
      }
      .form-group select,
      .form-group input {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.95rem;
        min-width: 140px;
      }
      .form-group select:focus,
      .form-group input:focus {
        outline: none;
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.1);
      }

      .radio-group {
        display: flex;
        gap: 16px;
      }
      .radio-group label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        font-size: 0.95rem;
      }
      .radio-group input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: var(--brand);
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-primary {
        background: var(--brand);
        color: #fff;
      }
      .btn-primary:hover:not(:disabled) {
        background: #0a3580;
        box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-success {
        background: #28a745;
        color: #fff;
      }
      .btn-success:hover {
        background: #218838;
      }

      .chart-container {
        width: 100%;
        height: 580px;
        margin-top: 16px;
      }
      .chart-title {
        text-align: center;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--brand);
        margin-bottom: 10px;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
      }
      .charts-grid .card {
        margin-bottom: 10px;
        border: 1px solid var(--border);
      }

      .info-text {
        font-size: 0.9rem;
        color: var(--muted);
        margin-top: 8px;
      }

      .station-boxes {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      .station-box {
        flex: 1;
        min-width: 220px;
        border: 2px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
        background: var(--bg);
      }
      .station-box-header {
        background: var(--brand);
        color: #fff;
        padding: 8px 14px;
        font-weight: 600;
        font-size: 0.9rem;
      }
      .station-box-content {
        padding: 14px;
        display: flex;
        gap: 16px;
        align-items: flex-end;
        flex-wrap: wrap;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: var(--muted);
      }
      .loading.active { display: block; }

      .no-data {
        text-align: center;
        padding: 40px;
        color: var(--muted);
        font-style: italic;
      }

      /* Print header - hidden on screen */
      .print-header {
        display: none;
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #333;
      }
      .print-header h1 {
        font-size: 1.5rem;
        margin: 0 0 5px;
        color: #0b3d91;
      }
      .print-header .subtitle {
        font-size: 1.1rem;
        color: #333;
        margin: 0;
      }
      .print-header .date-range {
        font-size: 1rem;
        color: #555;
        margin-top: 8px;
      }
      .print-header .division {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-top: 5px;
      }

      /* Print footer */
      .print-footer {
        display: none;
        margin-top: 30px;
        padding-top: 15px;
        border-top: 1px solid #ccc;
      }
      .print-footer-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }
      .print-footer-left {
        font-size: 0.95rem;
        color: #333;
      }
      .print-footer-right {
        font-size: 0.7rem;
        color: #888;
        text-align: right;
      }

      @page {
        margin: 10mm 10mm 10mm 10mm;
      }

      @media print {
        body { background: #fff; }
        header { display: none; }
        .print-header { display: block; }
        .print-footer { display: block; }
        .card { box-shadow: none; border: 1px solid #ddd; margin-bottom: 30px; }
        .form-card { display: none; }
        .btn { display: none; }
        .charts-grid { gap: 40px; }
        .charts-grid .card { page-break-inside: avoid; }
        .chart-container { height: 480px; }
      }
    </style>
  </head>
  <body>
    <div class="page-shell">
      <header>
        <div>
          <h1>Braking Pattern Analysis</h1>
          <span>Fortnightly Comparative Report</span>
        </div>
        <a href="spm.html" class="back-link">← Back to SPM Console</a>
      </header>

      <!-- Print Header (visible only on print) -->
      <div class="print-header">
        <h1>Braking Pattern Analysis</h1>
        <p class="subtitle">Fortnightly Comparative Report</p>
        <p class="date-range" id="printDateRange"></p>
        <p class="division">TRO-BB</p>
      </div>

      <!-- Selection Form -->
      <div class="card form-card">
        <h2 class="card-title">Report Parameters</h2>
        <div class="form-row">
          <div class="form-group">
            <label>Fortnight Period</label>
            <select id="fortnightSelect">
              <!-- Populated dynamically -->
            </select>
          </div>
          <div class="form-group">
            <label>No. of Runs</label>
            <select id="runCountSelect">
              <option value="10">10</option>
              <option value="15">15</option>
              <option value="20" selected>20</option>
              <option value="25">25</option>
              <option value="30">30</option>
            </select>
          </div>
          <div class="form-group">
            <button class="btn btn-primary" id="generateBtn" onclick="generateReport()">
              Generate Report
            </button>
          </div>
          <div class="form-group">
            <button class="btn btn-success" id="printBtn" onclick="window.print()" style="display: none;">
              Print / Save PDF
            </button>
          </div>
        </div>
        <div class="station-boxes" style="margin-top: 16px;">
          <div class="station-box">
            <div class="station-box-header">Chart 1</div>
            <div class="station-box-content">
              <div class="form-group">
                <label>Station</label>
                <select id="station1Select">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label>Direction</label>
                <div class="radio-group">
                  <label><input type="radio" name="direction1" value="DN" checked> DN</label>
                  <label><input type="radio" name="direction1" value="UP"> UP</label>
                </div>
              </div>
            </div>
          </div>
          <div class="station-box">
            <div class="station-box-header">Chart 2</div>
            <div class="station-box-content">
              <div class="form-group">
                <label>Station</label>
                <select id="station2Select">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label>Direction</label>
                <div class="radio-group">
                  <label><input type="radio" name="direction2" value="DN" checked> DN</label>
                  <label><input type="radio" name="direction2" value="UP"> UP</label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <p class="info-text">Select a fortnight, direction, and two stations to compare braking patterns at each station.</p>
      </div>

      <!-- Loading indicator -->
      <div class="loading" id="loading">
        <p>Loading braking data...</p>
      </div>

      <!-- Charts -->
      <div class="charts-grid" id="chartsContainer" style="display: none;">
        <div class="card">
          <div class="chart-title" id="chart1Title">Station 1 - Braking Analysis</div>
          <div class="chart-container" id="chart1"></div>
        </div>
        <div class="card">
          <div class="chart-title" id="chart2Title">Station 2 - Braking Analysis</div>
          <div class="chart-container" id="chart2"></div>
        </div>
      </div>

      <!-- Print Footer (visible only on print) -->
      <div class="print-footer">
        <div class="print-footer-content">
          <div class="print-footer-left">@Sr.DEE TRO-BB Division - report from crtms.in</div>
          <div class="print-footer-right">developed by Jayakumar M D MMan KYN</div>
        </div>
      </div>
    </div>

    <script>
      // API base - change for server deployment
      const CHART_API_BASE = "";  // Local: "", Server: "/spm/sub-spm"

      // Color palette for 20 lines (distinct colors)
      const LINE_COLORS = [
        '#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231',
        '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabed4',
        '#469990', '#dcbeff', '#9A6324', '#fffac8', '#800000',
        '#aaffc3', '#808000', '#ffd8b1', '#000075', '#a9a9a9'
      ];

      let chart1Instance = null;
      let chart2Instance = null;

      // Initialize fortnight dropdown
      function initFortnightDropdown() {
        const select = document.getElementById('fortnightSelect');
        const now = new Date();
        const options = [];

        // Start from the most recent complete fortnight and go back
        let year = now.getFullYear();
        let month = now.getMonth(); // 0-indexed
        let isSecondFortnight = now.getDate() > 15;

        // If we're in the first half, start from last month's second fortnight
        // If we're in the second half, start from this month's first fortnight
        if (!isSecondFortnight) {
          // We're in 1-15, so most recent complete is previous month's 16-end
          month--;
          if (month < 0) { month = 11; year--; }
          isSecondFortnight = true;
        } else {
          // We're in 16-end, so most recent complete is this month's 1-15
          isSecondFortnight = false;
        }

        // Generate last 6 complete fortnights
        for (let i = 0; i < 6; i++) {
          const monthName = new Date(year, month, 1).toLocaleString('default', { month: 'short' });
          const lastDay = new Date(year, month + 1, 0).getDate();
          const monthStr = String(month + 1).padStart(2, '0');

          if (isSecondFortnight) {
            options.push({
              label: `${monthName} ${year} (16-${lastDay})`,
              start: `${year}-${monthStr}-16`,
              end: `${year}-${monthStr}-${lastDay}`
            });
            isSecondFortnight = false;
          } else {
            options.push({
              label: `${monthName} ${year} (1-15)`,
              start: `${year}-${monthStr}-01`,
              end: `${year}-${monthStr}-15`
            });
            // Move to previous month's second fortnight
            month--;
            if (month < 0) { month = 11; year--; }
            isSecondFortnight = true;
          }
        }

        // Add to dropdown
        options.forEach(opt => {
          const option = document.createElement('option');
          option.value = `${opt.start}|${opt.end}`;
          option.textContent = opt.label;
          select.appendChild(option);
        });

        // Trigger station load on change
        select.addEventListener('change', loadStations);
        if (select.options.length > 0) {
          loadStations();
        }
      }

      // Load stations that have data for selected fortnight
      async function loadStations() {
        const fortnightVal = document.getElementById('fortnightSelect').value;
        if (!fortnightVal) return;

        const [startDate, endDate] = fortnightVal.split('|');

        try {
          const resp = await fetch(`${CHART_API_BASE}/braking-analysis/stations?start_date=${startDate}&end_date=${endDate}`);
          const data = await resp.json();

          const station1 = document.getElementById('station1Select');
          const station2 = document.getElementById('station2Select');

          // Clear and repopulate
          station1.innerHTML = '<option value="">-- Select --</option>';
          station2.innerHTML = '<option value="">-- Select --</option>';

          data.stations.forEach(stn => {
            station1.innerHTML += `<option value="${stn}">${stn}</option>`;
            station2.innerHTML += `<option value="${stn}">${stn}</option>`;
          });
        } catch (err) {
          console.error('Error loading stations:', err);
        }
      }

      // Generate the report
      async function generateReport() {
        const fortnightVal = document.getElementById('fortnightSelect').value;
        const station1 = document.getElementById('station1Select').value;
        const station2 = document.getElementById('station2Select').value;
        const direction1 = document.querySelector('input[name="direction1"]:checked').value;
        const direction2 = document.querySelector('input[name="direction2"]:checked').value;
        const runCount = document.getElementById('runCountSelect').value;

        if (!fortnightVal || !station1 || !station2) {
          alert('Please select fortnight and both stations');
          return;
        }

        const [startDate, endDate] = fortnightVal.split('|');

        // Show loading
        document.getElementById('loading').classList.add('active');
        document.getElementById('chartsContainer').style.display = 'none';
        document.getElementById('printBtn').style.display = 'none';

        try {
          // Fetch data for both stations in parallel (each with its own direction)
          const [data1, data2] = await Promise.all([
            fetch(`${CHART_API_BASE}/braking-analysis/data?station=${station1}&direction=${direction1}&start_date=${startDate}&end_date=${endDate}&limit=${runCount}`).then(r => r.json()),
            fetch(`${CHART_API_BASE}/braking-analysis/data?station=${station2}&direction=${direction2}&start_date=${startDate}&end_date=${endDate}&limit=${runCount}`).then(r => r.json())
          ]);

          // Hide loading
          document.getElementById('loading').classList.remove('active');

          // Update titles with route and train type info
          const type1 = data1.train_type ? `${data1.train_type}` : '';
          const type2 = data2.train_type ? `${data2.train_type}` : '';
          const count1 = data1.runs ? data1.runs.length : 0;
          const count2 = data2.runs ? data2.runs.length : 0;
          document.getElementById('chart1Title').textContent = `BRAKING ANALYSIS AT ${station1} (${direction1} - ${type1}) - ${count1} runs`;
          document.getElementById('chart2Title').textContent = `BRAKING ANALYSIS AT ${station2} (${direction2} - ${type2}) - ${count2} runs`;

          // Update print header with date range
          const formatDate = (d) => {
            const [y, m, day] = d.split('-');
            return `${day}/${m}/${y}`;
          };
          document.getElementById('printDateRange').textContent = `Period: ${formatDate(startDate)} to ${formatDate(endDate)}`;

          // IMPORTANT: Show container FIRST so charts get proper width
          document.getElementById('chartsContainer').style.display = 'grid';
          document.getElementById('printBtn').style.display = 'inline-block';

          // Small delay to ensure container is visible before rendering
          setTimeout(() => {
            renderBrakingChart('chart1', data1);
            renderBrakingChart('chart2', data2);

            // Force resize after render
            if (chart1Instance) chart1Instance.resize();
            if (chart2Instance) chart2Instance.resize();
          }, 100);

        } catch (err) {
          console.error('Error generating report:', err);
          document.getElementById('loading').classList.remove('active');
          alert('Error loading data: ' + err.message);
        }
      }

      // Render a braking chart
      function renderBrakingChart(containerId, data) {
        const container = document.getElementById(containerId);

        // Dispose existing chart
        if (containerId === 'chart1' && chart1Instance) {
          chart1Instance.dispose();
        } else if (containerId === 'chart2' && chart2Instance) {
          chart2Instance.dispose();
        }

        if (!data.runs || data.runs.length === 0) {
          container.innerHTML = '<div class="no-data">No data available for this station/direction/period</div>';
          return;
        }

        const chart = echarts.init(container);
        if (containerId === 'chart1') chart1Instance = chart;
        else chart2Instance = chart;

        // Build series - one per run
        // Use same logic as Platform Entry Analysis:
        // X = distance from halt (in meters), Y = speed
        // X-axis inverted so halt (0) is on the right
        const series = [];
        const legendData = [];

        // Get platform length for threshold line
        const platformLength = data.platform_length || 270;

        // Add threshold line (safe zone boundary)
        // Points: (platform_length, 45) → (130, 30) → (20, 15) → (0, 0)
        const thresholdData = [
          [platformLength, 45],  // Platform Entry: 45 km/h
          [130, 30],             // Mid Platform (130m): 30 km/h
          [20, 15],              // One Coach (20m): 15 km/h
          [0, 0]                 // Halt: 0 km/h
        ];

        // Safe zone (area below threshold) - light green
        series.push({
          name: 'Safe Zone',
          type: 'line',
          smooth: 0.3,
          symbol: 'none',
          lineStyle: { width: 2, color: '#28a745', type: 'dashed' },
          areaStyle: {
            color: 'rgba(40, 167, 69, 0.15)'  // Light green fill
          },
          data: thresholdData,
          z: 1  // Behind the braking lines
        });

        // Add braking lines for each run
        data.runs.forEach((run, idx) => {
          const color = LINE_COLORS[idx % LINE_COLORS.length];
          // Format date as DD/MM
          const dateStr = run.date_of_working ? run.date_of_working.substring(8, 10) + '/' + run.date_of_working.substring(5, 7) : '';
          const legendName = `${dateStr} ${run.train_number} - ${run.motorman_name}`;
          legendData.push(legendName);

          const haltKm = run.halt_km;

          // Convert points to [distanceFromHalt_meters, speed] format
          const lineData = [];
          for (const p of run.points) {
            // Distance from halt in meters
            const distFromHalt = (haltKm - p.cumulative_distance) * 1000;
            if (distFromHalt < 0) continue;  // Skip points past halt
            lineData.push([Math.round(distFromHalt), p.speed]);
          }

          series.push({
            name: legendName,
            type: 'line',
            smooth: true,
            symbol: 'circle',
            symbolSize: 0,
            showSymbol: false,
            lineStyle: { width: 4, color: color },
            itemStyle: { color: color },
            data: lineData,
            z: 2  // Above the safe zone
          });
        });

        const option = {
          tooltip: {
            trigger: 'axis',
            formatter: function(params) {
              if (!params || params.length === 0) return '';
              const dist = params[0].value[0];
              let result = `Distance: ${dist}m from halt<br/>`;
              params.forEach(p => {
                if (p.value && p.value[1] !== null) {
                  result += `${p.seriesName}: ${p.value[1].toFixed(1)} km/h<br/>`;
                }
              });
              return result;
            }
          },
          legend: {
            show: true,
            type: 'plain',
            orient: 'vertical',
            right: 10,
            top: 20,
            data: legendData,
            textStyle: { fontSize: 10 },
            itemWidth: 18,
            itemHeight: 10,
            itemGap: 6
          },
          grid: {
            left: '6%',
            right: '22%',
            bottom: '12%',
            top: '8%',
            containLabel: true
          },
          xAxis: {
            type: 'value',
            name: 'Distance from Halt',
            nameLocation: 'middle',
            nameGap: 25,
            inverse: true,  // So halt (0) is on the right
            splitNumber: 10,
            minInterval: 1,
            axisLabel: {
              fontSize: 10,
              formatter: function(value) {
                if (value === 0) return 'Halt';
                return value + 'm';
              }
            }
          },
          yAxis: {
            type: 'value',
            name: 'Speed (km/h)',
            nameLocation: 'middle',
            nameGap: 35,
            min: 0,
            max: 80,
            axisLabel: { fontSize: 10 }
          },
          series: series
        };

        chart.setOption(option);

        // Handle resize
        window.addEventListener('resize', () => chart.resize());
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', () => {
        initFortnightDropdown();
      });
    </script>
  </body>
</html>
