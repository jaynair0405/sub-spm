<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    



<script>
  document.addEventListener("DOMContentLoaded", function () {
  const saveButton = document.getElementById('saveButton');
  
  // Add click event to the save button
  saveButton.addEventListener("click", function () {
  saveButton.disabled = true;
  
  // Collect form data once
  const formData = collectFormData();
  
  // Basic validation to ensure required fields are filled
  if (!formData.mmanId || !formData.trainNumber || !formData.unitNumber || !formData.cliCmsId) {
  alert('Please fill all required fields.');
  saveButton.disabled = false; // Re-enable button if validation fails
  return;
  }
  
  // Pass the collected data to submitForm
  submitForm(formData);
  });
  });
  
  // Function to collect form data
  function collectFormData() {
    const fromStationSelect = document.getElementById('fromStation');
  const toStationSelect = document.getElementById('toStation');
  return {
  workingDate: document.getElementById('workingDate').value,
  mmanId: document.getElementById('mmanId').value,
  trainNumber: document.getElementById('trainNumber').value,
  trainType: document.getElementById('trainType').value,
  unitNumber: document.getElementById('unitNumber').value,
  wheelDia: document.getElementById('wheeldia').value,
  shed: document.getElementById('shed').value,
  cliCmsId: document.getElementById('cliCmsId').value,
  fromStation: fromStationSelect.options[fromStationSelect.selectedIndex].text,
    toStation: toStationSelect.options[toStationSelect.selectedIndex].text,
  mmanName: document.getElementById('mmanNameField').textContent,
  rakeType: document.getElementById('rakeTypeField').textContent,
  ncli: document.getElementById('nliField').textContent,
  analysingCli: document.getElementById('AnalysingCLIField').textContent
  };
  }
  
  // Submit the form and save data to the server
  function submitForm(formData) {
  google.script.run
  .withSuccessHandler((response) => {
  if (response === "Success") {
  alert('Data Saved Successfully!');
  
  // Clear input fields
  document.querySelectorAll('.input-group input').forEach(input => input.value = '');
  document.querySelectorAll('.input-group select').forEach(select => select.selectedIndex = 0);
  
  // Clear info fields
  document.querySelectorAll('.info-group .info-field').forEach(field => field.textContent = '');
  }
  saveButton.disabled = false;
  })
  .withFailureHandler((error) => {
  alert('Error: ' + error.message);
  saveButton.disabled = false;
  })
  .saveFormData(formData);
  }

</script>


<script>
document.querySelectorAll('.uppercase').forEach(input => {
    input.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
});
</script>


<script>
let staffDataCache = {};  // Global cache to store staff data

google.script.run.withSuccessHandler(cacheStaffData).getAllStaffData();

function cacheStaffData(data) {
    staffDataCache = {};  // Reset cache
    data.forEach(row => {
        const [id, name, mobile, ncli] = row;
        staffDataCache[id] = { name, mobile, ncli };
    });
}

document.getElementById("mmanId").addEventListener("input", function () {
    const mmanId = this.value.toUpperCase();  // Ensure uppercase
    const mmanData = staffDataCache[mmanId];

    // Display data or fallback to default
    document.getElementById("mmanNameField").textContent = mmanData ? mmanData.name : "Not Found";
    document.getElementById("nliField").textContent = mmanData && mmanData.ncli !== "-" ? mmanData.ncli : "NCLI Not Available";
    document.getElementById("mobileField").textContent = mmanData ? mmanData.mobile : "-";
});

</script>
<script>
  let cliDataCache = {};  // Cache for CLI data

// Fetch CLI data on load and store it in cache
google.script.run.withSuccessHandler(cacheCLIData).getAllCLIData();

function cacheCLIData(data) {
    cliDataCache = {};  // Reset cache
    data.forEach(row => {
        const [cliId, cliName] = row;
        cliDataCache[cliId] = cliName;  // Cache CLI ID and Name
    });
}

// Listen for input in the CLI ID field
document.getElementById("cliCmsId").addEventListener("input", function () {
    const cliId = this.value.toUpperCase();  // Convert to uppercase
    const cliName = cliDataCache[cliId];  // Get CLI Name from cache
    
    // Update the Analysing CLI field
    document.getElementById("AnalysingCLIField").textContent = cliName ? cliName : "Not Found";
});
</script>

<script>
// Rake type mapping based on unit number ranges
// Rake type mapping based on unit number ranges
function getRakeType(unitNumber) {
    const num = parseInt(unitNumber, 10);  // Convert to number for comparison
    
    // New series for Alstom (starts with 24)
    if (num >= 240000 && num <= 249999) {
        return "Alstom";
    }
    // New series for Medha U/S (starts with 80)
    else if (num >= 8000 && num <= 8099) {
        return "Medha U/S";
    }
    // Modified Siemens range - excluding the new Alstom range
    else if ((num >= 1000 && num <= 2999) || 
            (num >= 10000 && num <= 23999) || 
            (num >= 25000 && num <= 29999)) {
        return "Siemens";
    }
    else if (num >= 4000 && num <= 4999) {
        return "AC Retro";
    }
    else if (num >= 5000 && num <= 5999) {
        return "Bombardier";
    }
    else if (num >= 6000 && num <= 6999) {
        return "Medha";
    }
    else if (num >= 7000 && num <= 7999) {
        return "AC BHEL";
    }
    else {
        return "Not Found";
    }
}

// Listen for input in the Unit Number field
document.getElementById("unitNumber").addEventListener("input", function () {
    const unit = this.value;  // Get unit number input
    const rakeType = getRakeType(unit);  // Get the rake type
    
    // Update the Type of Rake field
    document.getElementById("rakeTypeField").textContent = rakeType;
});

</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    google.script.run
      .withSuccessHandler(populateStations)
      .getStations();
});


function populateStations(stations) {
    const fromStationSelect = document.getElementById("fromStation");
    const toStationSelect = document.getElementById("toStation");

    stations.forEach(function (station) {
        const option = document.createElement("option");
        option.value = station[0];  // Station ID
        option.textContent = station[1];  // Station Name
        fromStationSelect.appendChild(option);
        toStationSelect.appendChild(option.cloneNode(true));
    });
}
</script>

<script>
  
// TSR Entry functionality
let tsrCounter = 1;

function updateSlNumbers() {
    const rows = document.getElementById('tsrTableBody').getElementsByTagName('tr');
    for (let i = 0; i < rows.length; i++) {
        rows[i].getElementsByTagName('td')[0].textContent = i + 1;
    }
    tsrCounter = rows.length + 1;
}

function deleteTsrRow(button) {
    const row = button.closest('tr');
    row.remove();
    updateSlNumbers();
}

function calculateSpan(fromKm, toKm) {
    const span = Math.abs(parseFloat(toKm) - parseFloat(fromKm)).toFixed(2);
    return span;
}

function initializeTsrFunctionality() {
    const addTsrBtn = document.getElementById('addTsrBtn');
    const tsrTableBody = document.getElementById('tsrTableBody');

    addTsrBtn.addEventListener('click', function() {
        const fromKm = document.getElementById('fromKm').value;
        const toKm = document.getElementById('toKm').value;
        const speed = document.getElementById('speed').value;

        if (!fromKm || !toKm || !speed) {
            alert('Please fill all TSR fields');
            return;
        }

       const span = calculateSpan(fromKm, toKm);
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>${tsrCounter}</td>
            <td>${fromKm}</td>
            <td>${toKm}</td>
            <td>${span}</td>
            <td>${speed}</td>
            <td><button class="delete-btn" onclick="deleteTsrRow(this)">Delete</button></td>
        `;

        tsrTableBody.appendChild(newRow);
        tsrCounter++;

        // Clear input fields
        document.getElementById('fromKm').value = '';
        document.getElementById('toKm').value = '';
        document.getElementById('speed').value = '';
    });
    const saveTsrBtn = document.getElementById('saveTsrBtn');
    saveTsrBtn.addEventListener('click', saveTsrToSheet);
}

// Add this to your existing window.onload or document.ready function
window.addEventListener('load', function() {
    initializeTsrFunctionality();
});
</script>
<script>
function saveTsrToSheet() {
    const tsrTableBody = document.getElementById('tsrTableBody');
    const rows = tsrTableBody.getElementsByTagName('tr');
    const tsrData = [];
    
    // If no rows, show alert
    if (rows.length === 0) {
        alert('No TSR data to save');
        return;
    }
    
    // Convert table data to array
    for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        tsrData.push([
            cells[1].textContent, // From Km
            cells[2].textContent, // To Km
            cells[3].textContent, // Span
            cells[4].textContent, // Speed
            // new Date().toLocaleDateString() // Current date
        ]);
    }
    
    // Save to sheet using Apps Script
    google.script.run
        .withSuccessHandler(function() {
            alert('TSR data saved successfully');
            // Clear the table after saving
            tsrTableBody.innerHTML = '';
            tsrCounter = 1;
        })
        .withFailureHandler(function(error) {
            alert('Error saving TSR data: ' + error);
        })
        .saveTsrData(tsrData);
}

</script>

<script>
let processingComplete = false; // Flag to track processing status

document.getElementById("processBtn").addEventListener("click", function() {
  processingComplete = false; // Reset the flag
  document.getElementById("status").innerHTML = "Processing...";
  document.getElementById("progress").innerHTML = "";
  google.script.run
    .withSuccessHandler(updateStatus)
    .withFailureHandler(handleError) // Use a dedicated error handler
    .processSPMDataForAnalysis();
});

function updateStatus(status) {
  document.getElementById("status").innerHTML = status;
  document.getElementById("progress").innerHTML = "";
  console.log("test1");
  
  if (status === "Data processed successfully!") {
    processingComplete = true;
    console.log("test2");
    
    // Update UI to show completion without navigation
    document.getElementById("status").innerHTML = "Data processed successfully!";
    document.getElementById("progress").innerHTML = "Your data is ready.Go to Reports Page for Viewing/Generating Reports";
    
    // Optionally show results directly on this page
    // displayResults();
    
    // Re-enable any buttons if needed
    document.getElementById("processBtn").disabled = false;
    
  } else if (status.startsWith("Processing:")) {
    document.getElementById("status").innerHTML = status;
  } else {
    processingComplete = false;
  }
}

function handleError(e) {
  // Generic error handling function
  console.error("Error:", e);
  document.getElementById("status").innerHTML = "An error occurred: " + e;
  document.getElementById("progress").innerHTML = "";
  processingComplete = false;
  document.getElementById("processBtn").disabled = false; // Re-enable processing in case of an error
}
</script>

<script>
// Client-side JavaScript
let trainDataCache = {
  fast: {},  // Cache for fast trains data
  all: new Set()  // Cache for all trains (using Set for efficient lookup)
};
// Cache for train data
function loadAllTrainData() {
  // Load fast trains data
  google.script.run
    .withSuccessHandler(function(data) {
      trainDataCache.fast = data.reduce((acc, row) => {
        const trainNo = row[0].replace(/\s+/g, '');
        acc[trainNo] = row[2];  // Store halts for this train
        return acc;
      }, {});
    })
    .getTrainData();

  // Load all trains data
  google.script.run
    .withSuccessHandler(function(data) {
      trainDataCache.all = new Set(
        data.map(row => row[0].replace(/\s+/g, ''))
      );
    })
    .getAllLocalData();
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', loadAllTrainData);

// Add event listener for train number input
document.getElementById("trainNumber").addEventListener("input", function() {
  const trainNo = this.value.toUpperCase().replace(/\s+/g, '');
  let result;
  
  if (trainNo in trainDataCache.fast) {
    // Fast train - show specific halts
    result = trainDataCache.fast[trainNo];
  } else if (trainDataCache.all.has(trainNo)) {
    // Regular train - show "All Stations"
    result = "All Stations";
  } else {
    // Invalid/non-existent train
    result = "Not Found";
  }
  
  document.getElementById("haltsField").textContent = result;
});
</script>






</body>
</html>